<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szczecin Business Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .main-card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .industry-btn { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 8px 15px; margin: 4px; cursor: pointer; transition: all 0.2s; display: inline-block; }
        .industry-btn:hover { background: #e9ecef; border-color: #667eea; }
        .industry-btn.selected { background: #667eea; color: white; border-color: #667eea; }
        .business-card { border-left: 4px solid #667eea; transition: transform 0.2s; }
        .business-card:hover { transform: translateX(5px); }
        .business-card.has-website { border-left-color: #28a745; }
        .scan-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 15px 40px; font-size: 1.1rem; }
        .scan-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .scan-btn:disabled { opacity: 0.7; }
        .filter-btn { border-radius: 20px; }
        .filter-btn.active { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="text-center text-white mb-4">
                    <h1 class="display-4 fw-bold"><i class="bi bi-search"></i> Szczecin Business Scraper</h1>
                    <p class="lead">Znajdź firmy w Szczecinie i zbierz dane kontaktowe</p>
                </div>

                <div class="main-card p-4 p-md-5">
                    <!-- Scan Form -->
                    <div id="scanForm">
                        <h4 class="mb-3"><i class="bi bi-filter"></i> Wybierz branże do skanowania</h4>
                        <div id="industries" class="mb-4"></div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Max wyników na branżę</label>
                                <select class="form-select" id="maxResults">
                                    <option value="5">5 (szybkie)</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20" selected>20</option>
                                    <option value="30">30 (wolniejsze)</option>
                                </select>
                            </div>
                        </div>

                        <div class="text-center">
                            <button class="btn btn-primary btn-lg scan-btn" id="scanBtn" onclick="startScan()">
                                <i class="bi bi-rocket-takeoff"></i> Skanuj firmy
                            </button>
                        </div>
                    </div>

                    <!-- Progress -->
                    <div id="progress" style="display:none" class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" style="width:3rem;height:3rem;"></div>
                        <h4>Skanowanie...</h4>
                        <p class="text-muted" id="progressText">Przygotowywanie...</p>
                        <div class="progress mt-3" style="height:20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="results" style="display:none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-check-circle text-success"></i> Wyniki</h4>
                            <button class="btn btn-outline-primary" onclick="reset()"><i class="bi bi-arrow-repeat"></i> Nowe</button>
                        </div>

                        <div class="alert alert-info">
                            Znaleziono <strong id="resultCount">0</strong> firm w katalogach biznesowych!
                        </div>

                        <div class="mb-3">
                            <span class="me-2">Filtruj:</span>
                            <button class="btn btn-sm btn-outline-secondary filter-btn active" onclick="filterResults('all')">Wszystkie</button>
                            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="filterResults('noWeb')">Bez WWW</button>
                            <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="filterResults('withWeb')">Ze stroną WWW</button>
                        </div>

                        <div id="businessList"></div>
                        <div class="text-center mt-4">
                            <button class="btn btn-success btn-lg" onclick="downloadCSV()">
                                <i class="bi bi-download"></i> Pobierz CSV
                            </button>
                        </div>
                    </div>
                </div>

                <div class="text-center text-white mt-4">
                    <a href="https://github.com/fpawlun-code/reachbot" target="_blank" class="text-white">
                        <i class="bi bi-github"></i> GitHub
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const INDUSTRIES = ['restauracje','kawiarnie','fryzjerzy','dentyści','mechanicy','piekarnie','kwiaciarnie','prawnicy','hotele','siłownie'];
        let selected = new Set(['restauracje']);
        let allResults = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            const cont = document.getElementById('industries');
            INDUSTRIES.forEach(ind => {
                const btn = document.createElement('span');
                btn.className = 'industry-btn' + (selected.has(ind) ? ' selected' : '');
                btn.textContent = ind;
                btn.onclick = () => {
                    if (selected.has(ind)) selected.delete(ind);
                    else selected.add(ind);
                    btn.classList.toggle('selected');
                };
                cont.appendChild(btn);
            });
        });

        async function startScan() {
            if (selected.size === 0) { alert('Wybierz branżę!'); return; }

            document.getElementById('scanForm').style.display = 'none';
            document.getElementById('progress').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            const max = document.getElementById('maxResults').value;
            const industries = Array.from(selected);
            allResults = [];

            for (let i = 0; i < industries.length; i++) {
                const ind = industries[i];
                document.getElementById('progressText').textContent = `Szukam: ${ind} w Szczecinie...`;
                document.getElementById('progressBar').style.width = ((i/industries.length)*100) + '%';

                try {
                    const res = await fetch(`/api/scan?industry=${encodeURIComponent(ind)}&max=${max}`);
                    const data = await res.json();
                    if (data.businesses) {
                        allResults = allResults.concat(data.businesses);
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').textContent = 'Gotowe!';
            setTimeout(showResults, 500);
        }

        function filterResults(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderBusinessList();
        }

        function getFilteredResults() {
            if (currentFilter === 'noWeb') return allResults.filter(b => !b.has_website);
            if (currentFilter === 'withWeb') return allResults.filter(b => b.has_website);
            return allResults;
        }

        function showResults() {
            document.getElementById('progress').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            document.getElementById('resultCount').textContent = allResults.length;
            currentFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.filter-btn').classList.add('active');
            renderBusinessList();
        }

        function renderBusinessList() {
            const filtered = getFilteredResults();
            const list = document.getElementById('businessList');

            if (filtered.length === 0) {
                list.innerHTML = '<div class="alert alert-warning">Brak wyników dla tego filtra.</div>';
                return;
            }

            list.innerHTML = filtered.map((b,i) => `
                <div class="card business-card mb-3 ${b.has_website ? 'has-website' : ''}">
                    <div class="card-body">
                        <h5>${b.name}</h5>
                        <span class="badge bg-secondary">${b.industry}</span>
                        ${b.has_website
                            ? `<span class="badge bg-success">Ma WWW</span>`
                            : `<span class="badge bg-danger">Brak WWW</span>`}
                        <div class="mt-2 small">
                            ${b.address ? `<div><i class="bi bi-geo-alt"></i> ${b.address}</div>` : ''}
                            ${b.phone ? `<div><i class="bi bi-telephone"></i> ${b.phone}</div>` : ''}
                            ${b.email ? `<div><i class="bi bi-envelope"></i> ${b.email}</div>` : ''}
                            ${b.website ? `<div><i class="bi bi-globe"></i> <a href="${b.website}" target="_blank">${b.website.substring(0,50)}...</a></div>` : ''}
                            ${b.facebook ? `<div><i class="bi bi-facebook"></i> <a href="${b.facebook}" target="_blank">Facebook</a></div>` : ''}
                            ${b.instagram ? `<div><i class="bi bi-instagram"></i> <a href="${b.instagram}" target="_blank">Instagram</a></div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function reset() {
            document.getElementById('scanForm').style.display = 'block';
            document.getElementById('progress').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
        }

        function downloadCSV() {
            const filtered = getFilteredResults();
            let csv = 'Nazwa;Branża;Adres;Telefon;Email;Strona WWW;Facebook;Instagram\n';
            filtered.forEach(b => {
                csv += `"${b.name}";"${b.industry}";"${b.address||''}";"${b.phone||''}";"${b.email||''}";"${b.website||''}";"${b.facebook||''}";"${b.instagram||''}"\n`;
            });
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'firmy_szczecin.csv';
            a.click();
        }
    </script>
</body>
</html>
