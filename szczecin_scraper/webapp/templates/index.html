<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szczecin Business Scraper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .industry-checkbox {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .industry-checkbox:hover {
            background: #e9ecef;
        }
        .industry-checkbox input:checked + label {
            color: #667eea;
            font-weight: 600;
        }
        .progress-container {
            display: none;
        }
        .results-container {
            display: none;
        }
        .business-card {
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }
        .business-card:hover {
            transform: translateX(5px);
        }
        .badge-no-website {
            background: #dc3545;
        }
        .badge-has-website {
            background: #28a745;
        }
        .scan-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
        }
        .scan-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header -->
                <div class="text-center text-white mb-4">
                    <h1 class="display-4 fw-bold">
                        <i class="bi bi-search"></i> Szczecin Business Scraper
                    </h1>
                    <p class="lead">Znajdź firmy bez stron internetowych - potencjalnych klientów!</p>
                </div>

                <!-- Main Card -->
                <div class="main-card p-4 p-md-5">
                    <!-- Form Section -->
                    <div id="formSection">
                        <h4 class="mb-4"><i class="bi bi-filter"></i> Wybierz branże do skanowania</h4>

                        <div class="row mb-4" id="industriesContainer">
                            {% for industry in industries %}
                            <div class="col-md-4 col-6">
                                <div class="industry-checkbox d-flex align-items-center">
                                    <input class="form-check-input me-2" type="checkbox"
                                           value="{{ industry }}" id="ind_{{ loop.index }}">
                                    <label class="form-check-label" for="ind_{{ loop.index }}">
                                        {{ industry|capitalize }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-sliders"></i> Max wyników na branżę</label>
                                <select class="form-select" id="maxResults">
                                    <option value="5">5 (szybki test)</option>
                                    <option value="10" selected>10 (zalecane)</option>
                                    <option value="20">20</option>
                                    <option value="50">50 (wolniejsze)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary" onclick="selectAll()">
                                        Zaznacz wszystkie
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="deselectAll()">
                                        Odznacz wszystkie
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button class="btn btn-primary btn-lg scan-btn" onclick="startScan()">
                                <i class="bi bi-rocket-takeoff"></i> Rozpocznij skanowanie
                            </button>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div id="progressSection" class="progress-container">
                        <div class="text-center mb-4">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                            <h4 id="progressStatus">Skanowanie w toku...</h4>
                            <p class="text-muted" id="progressDetail">Przygotowywanie...</p>
                        </div>

                        <div class="progress mb-3" style="height: 25px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 style="width: 0%">0%</div>
                        </div>

                        <div class="row text-center">
                            <div class="col-4">
                                <h3 id="statTotal" class="text-primary">0</h3>
                                <small class="text-muted">Znaleziono</small>
                            </div>
                            <div class="col-4">
                                <h3 id="statNoWebsite" class="text-danger">0</h3>
                                <small class="text-muted">Bez strony WWW</small>
                            </div>
                            <div class="col-4">
                                <h3 id="statProgress">0%</h3>
                                <small class="text-muted">Postęp</small>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection" class="results-container">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-check-circle text-success"></i> Wyniki skanowania</h4>
                            <div>
                                <button class="btn btn-success me-2" onclick="downloadResults()">
                                    <i class="bi bi-download"></i> Pobierz Excel
                                </button>
                                <button class="btn btn-outline-primary" onclick="resetForm()">
                                    <i class="bi bi-arrow-repeat"></i> Nowe skanowanie
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Znaleziono <strong id="resultCount">0</strong> firm bez własnej strony internetowej.
                            To potencjalni klienci na usługi web development!
                        </div>

                        <div id="businessList" class="mt-4">
                            <!-- Businesses will be loaded here -->
                        </div>

                        <div class="text-center mt-4">
                            <a href="/messages" class="btn btn-primary btn-lg">
                                <i class="bi bi-envelope"></i> Generuj wiadomości do wysłania
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center text-white mt-4">
                    <small>
                        <i class="bi bi-shield-check"></i>
                        Dane pobierane z publicznych katalogów firm. Używaj zgodnie z RODO.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentJobId = null;
        let statusCheckInterval = null;

        function getSelectedIndustries() {
            const checkboxes = document.querySelectorAll('#industriesContainer input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function selectAll() {
            document.querySelectorAll('#industriesContainer input').forEach(cb => cb.checked = true);
        }

        function deselectAll() {
            document.querySelectorAll('#industriesContainer input').forEach(cb => cb.checked = false);
        }

        function startScan() {
            const industries = getSelectedIndustries();
            const maxResults = document.getElementById('maxResults').value;

            if (industries.length === 0) {
                alert('Wybierz przynajmniej jedną branżę!');
                return;
            }

            // Show progress
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            // Start scan
            fetch('/api/scan/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({industries, max_results: maxResults})
            })
            .then(res => res.json())
            .then(data => {
                currentJobId = data.job_id;
                statusCheckInterval = setInterval(checkStatus, 1000);
            })
            .catch(err => {
                alert('Błąd: ' + err);
                resetForm();
            });
        }

        function checkStatus() {
            if (!currentJobId) return;

            fetch(`/api/scan/status/${currentJobId}`)
            .then(res => res.json())
            .then(data => {
                updateProgress(data);

                if (data.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    loadResults();
                } else if (data.status === 'error') {
                    clearInterval(statusCheckInterval);
                    alert('Błąd skanowania: ' + data.error);
                    resetForm();
                }
            });
        }

        function updateProgress(data) {
            const progress = data.progress || 0;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').textContent = progress + '%';
            document.getElementById('statProgress').textContent = progress + '%';
            document.getElementById('statTotal').textContent = data.total_found || 0;
            document.getElementById('statNoWebsite').textContent = data.without_website || 0;

            if (data.current_industry) {
                document.getElementById('progressDetail').textContent =
                    'Skanowanie: ' + data.current_industry;
            }
        }

        function loadResults() {
            fetch(`/api/scan/results/${currentJobId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultCount').textContent = data.total;

                const container = document.getElementById('businessList');
                container.innerHTML = '';

                if (data.businesses.length === 0) {
                    container.innerHTML = '<div class="alert alert-warning">Nie znaleziono firm bez strony WWW.</div>';
                    return;
                }

                // Store for messages page
                localStorage.setItem('scrapedBusinesses', JSON.stringify(data.businesses));

                data.businesses.forEach((biz, idx) => {
                    const card = document.createElement('div');
                    card.className = 'card business-card mb-3';
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">${biz.name}</h5>
                                    <span class="badge bg-secondary">${biz.industry}</span>
                                    <span class="badge badge-no-website">Brak strony WWW</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="copyContact(${idx})">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div class="mt-3 row">
                                <div class="col-md-6">
                                    ${biz.address ? `<p class="mb-1"><i class="bi bi-geo-alt"></i> ${biz.address}</p>` : ''}
                                    ${biz.phone ? `<p class="mb-1"><i class="bi bi-telephone"></i> ${biz.phone}</p>` : ''}
                                    ${biz.email ? `<p class="mb-1"><i class="bi bi-envelope"></i> ${biz.email}</p>` : ''}
                                </div>
                                <div class="col-md-6">
                                    ${biz.facebook ? `<p class="mb-1"><i class="bi bi-facebook"></i> <a href="${biz.facebook}" target="_blank">Facebook</a></p>` : ''}
                                    ${biz.instagram ? `<p class="mb-1"><i class="bi bi-instagram"></i> <a href="${biz.instagram}" target="_blank">Instagram</a></p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        function downloadResults() {
            if (currentJobId) {
                window.location.href = `/api/scan/download/${currentJobId}`;
            }
        }

        function resetForm() {
            clearInterval(statusCheckInterval);
            currentJobId = null;
            document.getElementById('formSection').style.display = 'block';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
        }

        function copyContact(idx) {
            const businesses = JSON.parse(localStorage.getItem('scrapedBusinesses') || '[]');
            const biz = businesses[idx];
            if (biz) {
                const text = `${biz.name}\n${biz.address || ''}\nTel: ${biz.phone || ''}\nEmail: ${biz.email || ''}`;
                navigator.clipboard.writeText(text);
                alert('Skopiowano do schowka!');
            }
        }
    </script>
</body>
</html>
